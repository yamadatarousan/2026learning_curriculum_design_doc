# コードレビュー観点表

このドキュメントは、Goのコードレビューで確認すべき観点をまとめたチェックリストです。
特に、Ginフレームワークを使ったWebアプリケーションを対象としています。

---

## 1. Correctness（正しさ）

### 1.1 ロジック

- [ ] ビジネスロジックが要件を満たしているか
- [ ] エッジケースが適切に処理されているか（空配列、nil、0など）
- [ ] 境界値が正しく処理されているか
- [ ] ループの開始・終了条件が正しいか
- [ ] 条件分岐のロジックが正しいか（特に複雑な条件）

### 1.2 エラーハンドリング

- [ ] すべてのエラーが適切に処理されているか
- [ ] エラーを無視していないか（`_ = ...` は要注意）
- [ ] エラーメッセージに十分なコンテキストが含まれているか
- [ ] エラーをラップする際に `fmt.Errorf("%w", err)` を使っているか
- [ ] panicが適切に回復されているか（recover）

### 1.3 並行処理

- [ ] data raceの可能性はないか
- [ ] goroutineのリークはないか（適切に終了するか）
- [ ] mutexのlock/unlockが対になっているか
- [ ] deferでunlockしているか
- [ ] チャネルのclose漏れはないか
- [ ] contextのキャンセルが適切に処理されているか

### 1.4 データベース

- [ ] SQLインジェクションの脆弱性はないか
- [ ] N+1クエリの問題はないか
- [ ] トランザクションが適切に使われているか
- [ ] トランザクションのcommit/rollbackが適切か
- [ ] 接続のリーク（close漏れ）はないか
- [ ] インデックスが適切に使われているか

---

## 2. Design（設計）

### 2.1 関数・メソッド

- [ ] 関数が単一責任の原則に従っているか
- [ ] 関数が適切な長さか（目安: 50行以内）
- [ ] 引数が多すぎないか（目安: 3個以内、構造体にまとめる）
- [ ] 戻り値が多すぎないか（目安: 2個以内、構造体にまとめる）
- [ ] 副作用が明確か（特にグローバル変数の変更）

### 2.2 構造体・インターフェース

- [ ] 構造体のフィールドが適切か（public/privateの使い分け）
- [ ] インターフェースが小さいか（1-3メソッド推奨）
- [ ] インターフェースが本当に必要か（過度な抽象化を避ける）
- [ ] 構造体の責務が明確か

### 2.3 依存関係

- [ ] 依存の方向が適切か（上位層→下位層）
- [ ] 循環依存はないか
- [ ] 具象ではなくインターフェースに依存しているか（必要な場合）
- [ ] DIパターンが適切に使われているか

### 2.4 パッケージ構成

- [ ] パッケージの分割が適切か
- [ ] publicな関数・型が最小限か
- [ ] パッケージ名が明確か（短く、わかりやすく）

---

## 3. Readability（可読性）

### 3.1 命名

- [ ] 変数名が意味を表しているか（`x`, `tmp` などは避ける）
- [ ] 関数名が動詞で始まっているか（`GetUser`, `CreateTodo`）
- [ ] bool変数が `is`, `has`, `can` などで始まっているか
- [ ] 定数が大文字のスネークケースか（`MAX_RETRY_COUNT`）
- [ ] パッケージ名が小文字の単語か
- [ ] 略語が一般的なものか（`URL`, `ID` はOK、独自略語は避ける）

### 3.2 コメント

- [ ] 複雑なロジックにコメントがあるか
- [ ] なぜそうしたかの理由が書かれているか（何をしているかは自明）
- [ ] TODO/FIXMEが残っていないか（残す場合は理由とチケット番号）
- [ ] 公開関数にドキュメントコメントがあるか
- [ ] コメントアウトされたコードが残っていないか

### 3.3 フォーマット

- [ ] `gofmt` が適用されているか
- [ ] インデントが一貫しているか
- [ ] 不要な空行がないか
- [ ] import文が整理されているか（標準→サードパーティ→自パッケージ）

### 3.4 マジックナンバー

- [ ] マジックナンバーが定数化されているか
- [ ] 定数名が意味を表しているか

---

## 4. Test（テスト）

### 4.1 テストカバレッジ

- [ ] 新しいコードにテストがあるか
- [ ] 重要なビジネスロジックがテストされているか
- [ ] エッジケースがテストされているか
- [ ] エラーケースがテストされているか

### 4.2 テストの品質

- [ ] テストが独立しているか（順序に依存しない）
- [ ] テストデータがハードコードされていないか（テストフィクスチャの利用）
- [ ] テスト名が何をテストしているか明確か
- [ ] Arrange-Act-Assertパターンに従っているか
- [ ] モックが適切に使われているか（過度なモックは避ける）

### 4.3 統合テスト

- [ ] DB込みの統合テストがあるか
- [ ] テストDBの初期化・クリーンアップが適切か
- [ ] テストが並列実行可能か

---

## 5. Security（セキュリティ）

### 5.1 入力検証

- [ ] ユーザー入力が検証されているか
- [ ] バリデーションエラーメッセージが適切か（内部情報を漏らさない）
- [ ] 入力の長さ制限があるか
- [ ] 型の検証があるか

### 5.2 認証・認可

- [ ] 認証が必要なエンドポイントに認証チェックがあるか
- [ ] 認可（権限チェック）が適切か
- [ ] JWTのシークレットがハードコードされていないか
- [ ] パスワードがハッシュ化されているか（bcrypt推奨）
- [ ] セッションタイムアウトが適切か

### 5.3 SQLインジェクション

- [ ] プリペアドステートメントまたはORMを使っているか
- [ ] 文字列結合でSQLを組み立てていないか

### 5.4 XSS（クロスサイトスクリプティング）

- [ ] HTMLのエスケープが適切か
- [ ] JSONレスポンスのContent-Typeが正しいか

### 5.5 機密情報

- [ ] パスワード、トークンがログに出力されていないか
- [ ] 機密情報が平文で保存されていないか
- [ ] 環境変数から機密情報を読み込んでいるか
- [ ] `.env` ファイルが `.gitignore` に含まれているか

### 5.6 CORS

- [ ] CORS設定が適切か（ワイルドカードは本番では避ける）
- [ ] 許可するオリジンが明示的か

---

## 6. Performance（パフォーマンス）

### 6.1 データベース

- [ ] N+1クエリがないか
- [ ] 適切なインデックスが使われているか
- [ ] 不要なデータを取得していないか（SELECT *を避ける）
- [ ] ページネーションが実装されているか（大量データの場合）

### 6.2 メモリ

- [ ] 不要なメモリ割り当てがないか
- [ ] スライスの事前確保が適切か（`make([]T, 0, capacity)`）
- [ ] 大きなデータをコピーしていないか（ポインタを使うべきか）
- [ ] メモリリークの可能性はないか

### 6.3 ループ・アルゴリズム

- [ ] ループ内で不要な処理をしていないか
- [ ] アルゴリズムの計算量が適切か（O(n²)は避ける）
- [ ] 文字列連結で `+=` を使っていないか（`strings.Builder`を使う）

### 6.4 並行処理

- [ ] 並行処理が本当に必要か
- [ ] goroutineの数が制限されているか（無制限に起動していないか）
- [ ] worker poolパターンが適切に使われているか

---

## 7. Framework Specific（Gin フレームワーク固有）

### 7.1 Handler（ハンドラ）

- [ ] ハンドラの責務が適切か（薄く保つ）
  - リクエストの受け取り
  - バリデーション
  - サービス層の呼び出し
  - レスポンスの返却
- [ ] ビジネスロジックがハンドラに書かれていないか
- [ ] `c.JSON()`, `c.String()` などで適切にレスポンスを返しているか
- [ ] エラー時に適切なHTTPステータスコードを返しているか

### 7.2 Middleware（ミドルウェア）

- [ ] ミドルウェアの順序が適切か
  - Recovery → Logger → CORS → Auth → 業務ロジック
- [ ] ミドルウェアが単一責任か
- [ ] `c.Next()` が適切に呼ばれているか
- [ ] ミドルウェアでリクエストを中断する場合、`c.Abort()` を呼んでいるか
- [ ] contextに値を保存する場合、`c.Set()` を使っているか

### 7.3 Routing（ルーティング）

- [ ] ルートグループが適切に使われているか
- [ ] RESTfulな設計になっているか
  - `GET /todos` - 一覧取得
  - `POST /todos` - 作成
  - `GET /todos/:id` - 詳細取得
  - `PUT /todos/:id` - 更新
  - `DELETE /todos/:id` - 削除
- [ ] バージョニングが考慮されているか（`/api/v1/...`）

### 7.4 Context

- [ ] `gin.Context` を構造体のフィールドに保存していないか（リクエスト終了後に無効）
- [ ] contextから値を取得する際、存在チェックをしているか
- [ ] context経由でDBやserviceを渡していないか（DIで渡すべき）

### 7.5 Binding & Validation

- [ ] `c.ShouldBindJSON()` でバインドしているか（`BindJSON`はpanic）
- [ ] バリデーションタグが適切か（`binding:"required"` など）
- [ ] カスタムバリデーションが必要な場合、適切に実装されているか

### 7.6 Error Handling

- [ ] エラーハンドリングミドルウェアが実装されているか
- [ ] エラーレスポンスの形式が統一されているか
  ```json
  {
    "error": "error message",
    "code": "ERROR_CODE"
  }
  ```
- [ ] 内部エラーの詳細を外部に漏らしていないか

---

## 8. Repository Pattern（データアクセス層）

### 8.1 責務

- [ ] Repositoryがデータアクセスのみを担当しているか
- [ ] ビジネスロジックがRepositoryに含まれていないか
- [ ] SQLの組み立てがRepositoryに集約されているか

### 8.2 インターフェース

- [ ] Repositoryがインターフェースで定義されているか
- [ ] インターフェースがテストしやすい粒度か

### 8.3 トランザクション

- [ ] トランザクションの管理が適切な層で行われているか
- [ ] Repository外（Service層など）でトランザクションを制御しているか
- [ ] トランザクションを引数で受け取る設計になっているか

---

## 9. Configuration（設定管理）

### 9.1 環境変数

- [ ] 環境依存の値がハードコードされていないか
- [ ] 環境変数のデフォルト値が適切か
- [ ] 環境変数名が明確か（`DB_HOST`, `JWT_SECRET` など）

### 9.2 設定ファイル

- [ ] 設定ファイルが適切に読み込まれているか
- [ ] 設定の検証（バリデーション）があるか
- [ ] 必須設定が欠けている場合、起動時にエラーになるか

---

## 10. Logging（ログ）

### 10.1 ログレベル

- [ ] ログレベルが適切か（DEBUG/INFO/WARN/ERROR）
- [ ] 本番環境でDEBUGログが出ないようになっているか

### 10.2 ログ内容

- [ ] ログに十分なコンテキスト（request ID, user IDなど）が含まれているか
- [ ] エラーログにスタックトレースが含まれているか
- [ ] 機密情報（パスワード、トークン）がログに出力されていないか

### 10.3 構造化ログ

- [ ] 構造化ログ（JSON形式など）が使われているか
- [ ] ログが検索しやすい形式か

---

## 11. Documentation（ドキュメント）

### 11.1 README

- [ ] セットアップ手順が記載されているか
- [ ] 実行方法が記載されているか
- [ ] 環境変数の説明があるか
- [ ] API仕様へのリンクがあるか

### 11.2 API仕様

- [ ] エンドポイント一覧があるか
- [ ] リクエスト・レスポンスの例があるか
- [ ] 認証方法が説明されているか
- [ ] エラーレスポンスの形式が説明されているか

### 11.3 コード内ドキュメント

- [ ] 公開関数にドキュメントコメントがあるか
- [ ] 複雑な処理に説明コメントがあるか

---

## 12. Git & Version Control

### 12.1 コミット

- [ ] コミットメッセージが明確か
- [ ] 1コミット1機能になっているか
- [ ] 不要なファイルがコミットされていないか

### 12.2 ブランチ

- [ ] ブランチ名が規約に従っているか（`feature/xxx`, `fix/xxx`）
- [ ] マージ前に最新のmainをマージしているか

### 12.3 Pull Request

- [ ] PRの説明が十分か（何を、なぜ変更したか）
- [ ] レビュアーが指定されているか
- [ ] CIが通っているか

---

## セルフレビューの進め方

### 1. コードを書いた直後

- [ ] 自分でコードを一度読み直す
- [ ] 明らかなミスがないか確認
- [ ] テストを実行して通ることを確認

### 2. PR作成前

- [ ] このチェックリストを使って網羅的にチェック
- [ ] 重要な観点（Correctness, Security）を重点的に確認
- [ ] 不要なコードやコメントを削除

### 3. レビュー指摘後

- [ ] 指摘事項を理解したか確認
- [ ] 同様の問題が他にないか確認
- [ ] 修正後、再度セルフレビュー

---

## レビューの優先順位

1. **Critical（致命的）**: Correctness, Security
2. **High（高）**: Design, Test
3. **Medium（中）**: Performance, Framework Specific
4. **Low（低）**: Readability, Documentation

---

**最終更新**: 2026-01-04
