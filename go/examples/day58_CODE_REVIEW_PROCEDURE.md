# Day 58: コードレビュー 実行手順

## 今日の成果物

1. `day58_code_review_checklist.md` - コードレビュー観点表（完全版）
2. `day58_self_review_example.md` - セルフレビューの実施例
3. このファイル - 実行手順書

---

## 実行手順

### 手順1: コードレビュー観点表の確認

```bash
cd /Users/user/Development/2026learning_curriculum_design_doc/go/examples

# 観点表を確認
cat day58_code_review_checklist.md
```

**確認すべき内容**:
- 12のカテゴリに分かれている
- Correctness（正しさ）
- Design（設計）
- Readability（可読性）
- Test（テスト）
- Security（セキュリティ）
- Performance（パフォーマンス）
- Framework Specific（Gin固有）
- Repository Pattern
- Configuration（設定管理）
- Logging（ログ）
- Documentation（ドキュメント）
- Git & Version Control

---

### 手順2: セルフレビュー実施例の確認

```bash
# セルフレビュー例を確認
cat day58_self_review_example.md
```

**注目ポイント**:
- day54のコードに対する実際のレビュー結果
- 優先度別に問題点を分類（Critical/High/Medium/Low）
- 具体的な改善案を提示

---

### 手順3: 実際にセルフレビューを実施

#### ステップ1: レビュー対象のコードを開く

```bash
# day54のコードを確認
cd /Users/user/Development/2026learning_curriculum_design_doc/go/day54
cat main.go
```

#### ステップ2: チェックリストを使ってレビュー

観点表のチェックリストを使って、以下の観点で確認：

**最優先（Critical）**:
- [ ] JWTシークレットがハードコードされていないか
- [ ] エラーの詳細を外部に漏らしていないか
- [ ] SQLインジェクションの脆弱性はないか
- [ ] パスワードがハッシュ化されているか

**重要（High）**:
- [ ] グローバル変数を使っていないか
- [ ] ハンドラが太すぎないか（責務の分離）
- [ ] テストがあるか

**中程度（Medium）**:
- [ ] エラーレスポンスの形式が統一されているか
- [ ] ログが適切に出力されているか
- [ ] パフォーマンスの問題はないか

#### ステップ3: 問題点をリストアップ

見つかった問題点をメモする：

```markdown
# セルフレビュー結果

## Critical
1. JWTシークレットがハードコード（line 42）
2. ...

## High
1. グローバル変数の使用（line 41）
2. ...

## Medium
1. ...
```

---

### 手順4: 改善の優先順位を決定

発見された問題を優先度順に並べる：

| 優先度 | 問題点 | 改善見積もり |
|--------|--------|-------------|
| 🔴 Critical | JWTシークレット環境変数化 | 10分 |
| 🔴 Critical | エラー詳細の非表示 | 5分 |
| 🟡 High | レイヤー分離 | 2時間 |
| 🟢 Medium | エラーレスポンス統一 | 30分 |

---

### 手順5: 実際に修正を行う（オプション）

優先度の高い問題から修正する。

#### 例: JWTシークレットの環境変数化

**修正前**:
```go
var jwtSecret = []byte("a-very-secret-key")
```

**修正後**:
```go
var jwtSecret []byte

func init() {
    secret := os.Getenv("JWT_SECRET")
    if secret == "" {
        log.Fatal("JWT_SECRET environment variable is required")
    }
    jwtSecret = []byte(secret)
}
```

```.env ファイルを作成（.gitignoreに追加）**:
```
JWT_SECRET=your-super-secret-key-here
```

#### 例: エラー詳細の非表示

**修正前**:
```go
c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
    "error": "Invalid token",
    "details": err.Error()  // 詳細を返している
})
```

**修正後**:
```go
// ログには詳細を記録
log.Printf("Token validation failed: %v", err)

// クライアントには最小限の情報のみ
c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
    "error": "Invalid token"
})
```

---

### 手順6: 修正後の確認

```bash
# テストを実行
go test -v

# アプリケーションを起動
JWT_SECRET=test-secret go run main.go

# 動作確認
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'
```

---

## レビューの観点（重要なポイント）

### 1. Correctness（正しさ） - 最優先

**チェック項目**:
- [ ] ビジネスロジックが要件を満たしているか
- [ ] エッジケースが処理されているか（nil, 空配列, 0など）
- [ ] すべてのエラーが適切に処理されているか

**よくある問題**:
- エラーを無視（`_ = ...`）
- nil チェック漏れ
- 境界値の処理ミス

---

### 2. Security（セキュリティ） - 最優先

**チェック項目**:
- [ ] 機密情報がハードコードされていないか
- [ ] SQLインジェクションの脆弱性はないか
- [ ] パスワードがハッシュ化されているか
- [ ] JWTシークレットが環境変数か
- [ ] エラーメッセージに内部情報が含まれていないか

**よくある問題**:
- JWTシークレットのハードコード
- 文字列連結でSQLを組み立て
- エラー詳細の漏洩

---

### 3. Design（設計） - 重要

**チェック項目**:
- [ ] 関数が単一責任か
- [ ] レイヤーが適切に分離されているか
- [ ] テストしやすい設計か

**よくある問題**:
- ハンドラが太すぎる（ビジネスロジックが混在）
- グローバル変数の使用
- 依存関係が不明確

---

### 4. Framework Specific（Gin固有） - 重要

**チェック項目**:
- [ ] ハンドラの責務が適切か（薄く保つ）
- [ ] ミドルウェアの順序が適切か
- [ ] `c.ShouldBindJSON()` を使っているか（`BindJSON`はpanic）
- [ ] エラーハンドリングが統一されているか

**よくある問題**:
- ハンドラにビジネスロジックを書く
- ミドルウェアの順序ミス
- contextの誤用

---

### 5. Test（テスト）

**チェック項目**:
- [ ] 重要なビジネスロジックにテストがあるか
- [ ] エッジケースがテストされているか
- [ ] テストが独立しているか

**よくある問題**:
- テストがない
- テストの順序依存
- モックの過度な使用

---

## セルフレビューのベストプラクティス

### 1. 時間を置いてレビュー

コードを書いた直後ではなく、少し時間を置いてからレビューする（翌日など）

### 2. チェックリストを活用

観点表を印刷またはデジタルで開いておき、漏れなくチェックする

### 3. 優先順位をつける

すべての問題を一度に直そうとせず、Critical → High → Medium の順に対応

### 4. 他人のコードだと思って読む

自分が書いたコードでも、初めて見るコードのように読む

### 5. ツールを活用

```bash
# 静的解析ツール
go vet ./...

# Linter
golangci-lint run

# セキュリティチェック
gosec ./...
```

---

## 実務でのコードレビュー

### レビュー依頼時（Author側）

1. **セルフレビューを先に実施**
   - このチェックリストを使う
   - 明らかな問題は修正してからPR作成

2. **PR説明を充実させる**
   - 何を変更したか
   - なぜ変更したか
   - どうやってテストしたか

3. **小さくまとめる**
   - 1PR = 1機能
   - 大きすぎる変更は分割

### レビュー実施時（Reviewer側）

1. **観点を絞る**
   - Correctness, Security を最優先
   - 細かいスタイルは自動ツールに任せる

2. **建設的なフィードバック**
   - 「なぜ」を説明する
   - 代替案を提示する
   - 否定ではなく提案

3. **質問形式で**
   - 「ここは〜すべきです」→「〜した方が良いかもしれません。どう思いますか？」

---

## 学習のポイント

### 1. セキュリティは妥協しない

- JWTシークレットのハードコード
- SQLインジェクション
- エラー情報の漏洩

これらは本番環境では致命的。必ず修正。

### 2. 設計は後から改善できる

- レイヤー分離
- グローバル変数の削除

最初から完璧を目指さず、段階的に改善。

### 3. チェックリストは指針

チェックリストはあくまで指針。盲目的に従うのではなく、文脈を考慮する。

### 4. 継続的な改善

1回のレビューで完璧にするのではなく、継続的に改善していく。

---

**完了条件**:
- コードレビュー観点表の内容を理解
- セルフレビューの実施方法を理解
- 優先度の付け方を理解
- 実際にday54のコードをレビューして問題点を発見

---

**次のステップ（Day 59）**: Docker化（FWアプリ、マルチステージ）
